"use strict";var WPForms=window.WPForms||{};WPForms.Admin=WPForms.Admin||{},WPForms.Admin.Builder=WPForms.Admin.Builder||{},WPForms.Admin.Builder.Setup=WPForms.Admin.Builder.Setup||function(a,s){var o={},r={},i={init:function(){s(i.ready),s(a).on("load",function(){"function"==typeof s.ready.then?s.ready.then(i.load):i.load()})},ready:function(){i.setup(),i.setPanelsToggleState(),i.setupTitleFocus(),i.setTriggerBlankLink(),i.events(),o.$builder.trigger("wpformsBuilderSetupReady")},load:function(){i.applyTemplateOnRequest()},setup:function(){o={$builder:s("#wpforms-builder"),$form:s("#wpforms-builder-form"),$formName:s("#wpforms-setup-name"),$panel:s("#wpforms-panel-setup"),$categories:s("#wpforms-panel-setup .wpforms-setup-templates-categories")},r.templateList=new List("wpforms-setup-templates-list",{valueNames:["wpforms-template-name","wpforms-template-desc",{name:"categories",attr:"data-categories"}]}),r.spinner='<i class="wpforms-loading-spinner wpforms-loading-white wpforms-loading-inline"></i>',r.formID=o.$form.data("id")},events:function(){o.$panel.on("keyup","#wpforms-setup-template-search",i.searchTemplate).on("click",".wpforms-setup-templates-categories li",i.selectCategory).on("click",".wpforms-template-select",i.selectTemplate).on("click",".wpforms-trigger-blank",i.selectBlankTemplate),o.$builder.on("wpformsPanelSwitched",i.setupTitleFocus),o.$builder.on("input","#wpforms-panel-field-settings-form_title",i.syncTitle).on("input","#wpforms-setup-name",i.syncTitle)},setPanelsToggleState:function(){o.$builder.find("#wpforms-panels-toggle button:not(.active)").toggleClass("wpforms-disabled",""===r.formID)},setTriggerBlankLink:function(){o.$builder.find(".wpforms-trigger-blank").attr({"data-template-name-raw":"Blank Form","data-template":"blank"})},setupTitleFocus:function(e,t){"setup"===(t=void 0===t?wpf.getQueryString("view"):t)&&o.$formName.focus()},syncTitle:function(e){("wpforms-setup-name"===e.target.id?s("#wpforms-panel-field-settings-form_title"):s("#wpforms-setup-name")).val(e.target.value)},searchTemplate:function(e){r.templateList.search(s(this).val())},selectCategory:function(e){e.preventDefault();var t=s(this),e=t.closest("ul").find(".active"),a=t.data("category");e.removeClass("active"),t.addClass("active"),r.templateList.filter(function(e){return"all"===a||-1<e.values().categories.split(",").indexOf(a)})},selectTemplate:function(e){e.preventDefault();var t=s(e.target),a=o.$formName.val(),n=t.data("template"),e=t.data("template-name-raw");t.hasClass("education-modal")||(o.$panel.find(".wpforms-template").removeClass("active"),t.closest(".wpforms-template").addClass("active"),t.data("labelOriginal",t.html()),t.html(r.spinner+wpforms_builder.loading),o.$builder.trigger("wpformsTemplateSelect",n),a=a||e,r.formID?i.selectTemplateExistingForm(a,n,t):i.selectTemplateProcess(a,n,t))},selectBlankTemplate:function(e){o.$builder.find("#wpforms-template-blank .wpforms-template-select").trigger("click")},selectTemplateExistingForm:function(e,t,a){s.confirm({title:wpforms_builder.heads_up,content:wpforms_builder.template_confirm,backgroundDismiss:!1,closeIcon:!1,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action:function(){i.selectTemplateProcess(e,t,a)}},cancel:{text:wpforms_builder.cancel,action:function(){i.selectTemplateCancel()}}}})},selectTemplateProcess:function(e,t,a){a.data("addons")?i.addonsModal(e,t,a):i.selectTemplateProcessAjax(e,t)},selectTemplateCancel:function(){var e=o.$panel.find(".wpforms-template.active"),t=e.find(".wpforms-template-select");e.removeClass("active"),t.html(t.data("labelOriginal"))},selectTemplateProcessAjax:function(e,t){WPFormsBuilder.showLoadingOverlay();t={title:e,action:r.formID?"wpforms_update_form_template":"wpforms_new_form",template:t,form_id:r.formID,nonce:wpforms_builder.nonce};s.post(wpforms_builder.ajax_url,t).done(function(e){e.success?a.location.href=e.data.redirect:(wpf.debug(e),i.selectTemplateProcessError(e.data))}).fail(function(e,t,a){wpf.debug(e.responseText||t||""),i.selectTemplateProcessError("")})},selectTemplateProcessError:function(e){e=e&&e.length?"<p>"+e+"</p>":"";s.alert({title:wpforms_builder.heads_up,content:wpforms_builder.error_select_template+e,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action:function(){i.selectTemplateCancel(),WPFormsBuilder.hideLoadingOverlay()}}}})},addonsModal:function(e,t,a){var n=a.data("template-name-raw"),o=a.data("addons-names"),l=a.data("addons").split(","),a=1<l.length?wpforms_builder.template_addons_prompt:wpforms_builder.template_addon_prompt;l.length&&s.confirm({title:wpforms_builder.heads_up,content:a.replace(/%template%/g,n).replace(/%addons%/g,o),icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_education.install_confirm,btnClass:"btn-confirm",keys:["enter"],action:function(){return this.$$confirm.prop("disabled",!0).html(r.spinner+wpforms_education.activating),this.$$cancel.prop("disabled",!0),i.installActivateAddons(l,this,e,t),!1}},cancel:{text:wpforms_education.cancel,action:function(){i.selectTemplateCancel()}}}})},installActivateAddons:function(e,t,a,n){var o=[],l=[],s=!1;e.forEach(function(t){s="function"==typeof s.done?s.done(function(e){return o.push(e),i.installActivateAddonAjax(t)}).fail(function(e){l.push(e)}):i.installActivateAddonAjax(t)}),s.done(function(e){o.push(e)}).fail(function(e){l.push(e)}).always(function(){t.close(),0<o.length&&wpf.listPluck(o,"success").every(Boolean)&&0===l.length?i.selectTemplateProcessAjax(a,n):i.installActivateAddonsError(a,n)})},installActivateAddonsError:function(e,t){s.confirm({title:wpforms_builder.heads_up,content:wpforms_builder.template_addons_error,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.use_template,btnClass:"btn-confirm",keys:["enter"],action:function(){i.selectTemplateProcessAjax(e,t)}},cancel:{text:wpforms_builder.cancel,action:function(){i.selectTemplateCancel()}}}})},installActivateAddonAjax:function(e){var t=wpforms_addons[e],a=new s.Deferred;return!t||["activate","install"].indexOf(t.action)<0?(a.resolve(!1),a.promise()):s.post(wpforms_education.ajax_url,{action:"wpforms_"+t.action+"_addon",nonce:wpforms_builder.admin_nonce,plugin:"activate"===t.action?e+"/"+e+".php":t.url})},applyTemplateOnRequest:function(){var e=new URLSearchParams(a.location.search),t=e.get("template_id");"setup"===e.get("view")&&!e.get("form_id")&&t&&o.$panel.find('.wpforms-template .wpforms-btn[data-template="'+t+'"]').click()}};return i}((document,window),jQuery),WPForms.Admin.Builder.Setup.init();